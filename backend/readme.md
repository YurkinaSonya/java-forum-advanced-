# Задания

[Общее описание приложения](./draft/readme.md)

## Задание 1 - сервис файлов

Создать на spring-boot сервис, который будет включать в себя Rest-контроллер, позволяющий сохранять файлы
и загружать их по id. А так же просматривать информацию о том, какие файлы есть на сервере

### Функции сервиса

1. Загрузка файла
   Параметры запроса: контент файла и его название
   Параметры ответа: уникальный идентификатор файла внутри сервиса (по которому в дальнейшем)

2. Скачивание файла
   Параметры запроса: идентификатор файла, полученный при загрузке на сервер
   Параметры ответа: тело файла
   Примечание: файл в бразуере должен скачиваться под тем именем, под которым он загружался на сервер. Для этого нужно гуглить, как в спринге при скачивании файла задать имя для браузера.

3. Список файлов
   Тело ответа: массив dto-шек, в которых будут поля:
- Идентификатор файла
- Имя файла
- Размер файла
- Дата и время загрузки файла на сервер

Упрощения по сервису на текущем этапе:
- Может не сохранять файлы в файловые хранилища (like S3) и не сохранять их метаданные в БД, а держать эту инфу в памяти
- Может не иметь аутентификации/авторизации


## Задание 2 - (Модуль 1)

Разработать сервис ядра форума. Допущения:
- Может не быть аутентификации, т.к. ещё не проходили. Разрешается вместо куки/токена напрямую передавать логин
пользователя в моделях
- Может не быть системы миграции данных (Flyway / Liquibase), использовать auto-ddl у hibernate равный create в in-memory базе данных

#### Функции сервиса

Функции сервиса можно считать HTTP-методами этого сервиса. <br>
Каждая функция в случае ошибки должна отдавать понятный ответ в виде json и правильный http-статус 

- Создание категорий форума
- Редактирование категорий форума
- Удаление категорий форума
- Создание тем форума
- Редактирование тем форума
- Удаление тем форума
- Создание сообщений в темах форума
- Редактирование сообщений в темах форума
- Удаление сообщений в темах форума
- Получение полной структуры всех категорий форума в виде иерархии (дефолтная сортировка - по алфавиту на каждом уровне)
- Получение списка тем форума (пагинация, дефолтная сортировка - по дате создания по убыванию)
- Получение сообщений темы форума (пагинация, дефолтная сортировка - по дате создания по убыванию)
- Поиск категорий/тем/сообщений по подстроке без учёта регистра
- Поиск сообщений по следующему набору фильтров (пользователь может указать любые из этих фильтров)
  - Текст сообщения
  - Дата создания (возможность задания диапазона дат - от и до)
  - Автор сообщения (логин)
  - Тема форума (можно по id)
  - Категория форума (можно по id)

Последняя функция по поиску сообщений должна подразумевать, что может быть передан только один фильтр, может два,
а могут быть переданы и все фильтры. Может и ни одного.

#### Сущности сервиса

> Каждая сущность должна включать стандартный набор полей:
> - Суррогатный идентификатор (первичный ключ)
> - Дата создания записи
> - Дата модификации записи
> - Логин создателя записи

**Категория форма**. Сущность должна быть иерархичная. Набор полей
- Наименование
- Вышестоящая категория (родитель)

**Тема форума**
- Наименование
- Категория форума

**Сообщение**
- Текст сообщения
- Тема форума

На всякий случай, дубль ссылки на описание приложения: [Общее описание приложения](./draft/readme.md)

## Задание 3 - (Модуль 2)

> Задание на второй модуль - это логическое продолжение предыдущего задания.<br>
> Для выполнения не требуется создания отдельного репо, отдельной папки в репо или отдельной ветки в репо.<br>
> Выполнять задание нужно на основе кода из предыдущего задания

### Общие требования

- Все сущности БД системы должны создаваться миграцией БД
- Свойство hibernate - `ddl-auto` должно быть переведено в режим validate
- Во всех сервисах должна заработать аутентификация и авторизация. Эндпоинты должны быть защищены от анонимного
доступа, а так же должен разграничиваться доступ по роли

### Сервис пользователей

Сервис должен отвечать за хранение инфы о пользователях и за вход в систему

#### Функции сервиса

- Регистрация (роль при регистрации - пользователь)<br>
- Создание, редактирование, удаление пользователей (администратор)
- Блокирование пользователей (администратор)
- Назначение пользователям определенных ролей (администратор)
- Вход в системы через логин и пароль, валидация пароля. Выдача токенов.<br>
  Access-токен должен быть зашифрован
  - Генерация access токена (JWT) с содержимым
    - Основная информация о пользователе (логин и т.д.)
    - Роль пользователя
  - Генерация refresh-токена
- Обновление access-токена по refresh-токену

Все функции, кроме регистрации или входа в систему, должны быть закрыты аутентификацией

#### Особенности сервиса

- Система не должна позволять регистрировать пользователей с одинаковыми логинами

#### Сущности сервиса

**Пользователь**
- Логин
- Электронная почта (может быть в качестве логина)
- Хэш пароля
- ФИО
- Телефон
- Роль

### Сервис Ядро форума

Необходимо добавить аутентификацию и авторизацию в сервис
- Добавление аутентификации в сервис ядра форума
- Валидация токена, проверка его срока, валидности его подписи
- Проверка соответствия действия пользователя его роли

#### Функции сервиса

У сервиса должны появиться новые функции

- Добавление вложения к сообщению.<br>
Может быть добавлено только отправителем сообщения
- Удаление вложения
<br>Может выполняться отправителем сообщения или модератором/администратором

Файлы должны храниться в like S3 системе, например, minio

#### Сущности сервиса

У сервиса должны появиться новые сущности

**Вложение**
- Идентификатор файла в S3
- Наименование файла
- Размер файла

## Задание 4 - (Модуль 3)

> Задание на третий модуль - это логическое продолжение предыдущих заданий.<br>
> Для выполнения не требуется создания отдельного репо, отдельной папки в репо или отдельной ветки в репо.<br>
> Выполнять задание нужно на основе кода из предыдущего задания. Все требования предыдущих заданий сохраняются


### Сервис уведомлений

Смысл сервиса в том, чтобы другие сервисы через него могли посылать уведомления любыми каналами (почта,
мессенджеры, смс и т.д.), и чтобы пользователи через этот сервис могли просматривать историю уведомлений.<br>
В таком случае, сервис уведомлений должен реализовать прослушку топика Kafka для уведомлений. Получая уведомление,
сервис должен это уведомление сохранить в своей базе, и немедленно разослать его по всем каналам.
Так же сервис должен позволять пользователю просматривать все уведомления, которые ему когда либо приходили.
Уведомления, которые просматриваются пользователем через API сервиса (не внешние каналы доставки, типа мессенджеров),
должны иметь статус прочтения, чтобы пользователь мог различать что он уже прочел, что нет.

> Важно: обязательным каналом доставки (кроме хранения истории уведомлений в БД сервиса) является почта. Реализация
> отправки в мессенджер - опциональная, но сервис должен быть спроектирован так, чтобы добавление нового канала доставки 
> (доработка сервиса) было максимально простым.

#### Функции сервиса

Сервис по REST API должен быть доступен только залогиненному пользователю. Залогиненный пользователь не должен увидеть
"чужие" уведомления (те, у которых получатель не равен логину текущего юзера).

- Приём новых уведомлений через Kafka (обязательное условие - Apache Kafka)
  - Сохранение уведомления в БД
  - Рассылка по всем указанным каналам доставки
  - Сервису, инициирующему запрос на уведомление, должны предоставляться параметры:
    - Пул каналов доставки. Например, что-то отправлять только через почту, а что-то через все доступные каналы.
    - Флаг, будет ли отображено уведомление в истории. Например, уведомление с подтверждением регистрации показывать 
      по REST вовсе не обязательно
- Просмотр уведомлений (истории уведомлений) через REST API<br>
  - Пагинация
  - Возможность поиска: по заголовку или тексту уведомления
  - Сортировка по дате в порядке убывания
- Пометка уведомлений как прочитанных (флаг прочтения у уведомления должен меняться только вызовом API)
- Счётчик непрочитанных уведомлений. Предполагается, что будет выводиться на фронте над иконкой "колокольчика"

> Примечание к функции просмотра уведомлений. Если поиск в ней не задан, функция должна выводить сначала НЕ прочитанные
> уведомления. Если пользователю пришло 20 уведомлений, и он прочитал с 2-го по 18-е уведомление (останется 3
> непрочитанных), то открыв в следующий раз форму просмотра истории уведомлений, он будет ожидать, что ему сначала
> выведутся 20, 19 и 1 уведомления (которые ещё не прочёл), а дальше в порядке убывания даты-времени все остальные
> уведомления.

#### Сущности сервиса

У сервиса могут быть иные вспомогательные сущности, например, для мониторинга отправки почты, в мессенджеры.
Основная сущность сервиса:

**Уведомление**
- Заголовок
- Текст
- Получатель (логин/первичный ключ юзера)
- Дата создания
- Статус прочтения


### Сервис пользователей

По заданию требуется доработать сервис, чтобы он отправлял некоторые уведомления в сервис уведомлений, а так же
реализован новые функции REST API

#### Функции сервиса

- Расширение функции регистрации: отправка (kafka) уведомления со ссылкой подтверждения регистрации на почту нового пользователя. 
  Канал доставки - только почта
- Новая функция: Подтверждение регистрации через почту. То бишь REST-метод, по вызову которого должно произойти подтверждение
  нового аккаунта. Емейл при вызове метода передаваться не должен (только некий ключ - случайный набор символов).
- Уведомление об изменении роли. Если пользователю сменили роль, ему на все каналы должно прийти уведомление.
  Доставка всеми доступными в приложении каналами
- Уведомление о блокировке аккаунта. Доставка всеми доступными в приложении каналами

#### Сущности сервиса

Так или иначе должно произойти изменение схемы БД в связи с добавлением подтверждения регистрации.
Каким образом это будет сделано - предлагается придумать студенту.


### Сервис ядро форума

По заданию требуется доработать сервис, чтобы он отправлял некоторые уведомления в сервис уведомлений, а так же
реализован новые функции REST API

#### Функции сервиса

- Реализовать функции избранного у пользователей для топиков. Список избранных топиков должен быть свой у каждого пользователя.
  - Функция добавления топика в избранное
  - Функция удаления топика из избранного
  - Функция просмотра страницы избранного
    - Обязательно пагинация
    - Сортировка в порядке убывания даты-времени добавления в избранное
- Реализовать уведомление пользователей при появлении в избранных топиках новых сообщений от других пользователей.
  Доставка всеми доступными в приложении каналами


#### Сущности сервиса

Как минимум должна появиться сущность Избранное. Студент должен самостоятельно определить набор необходимых полей
для реализации функционала.